name: CI

on:
  pull_request:
    branches: [master]
  push:
    branches: [master]

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile

      - name: Lint shell scripts
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: .
          severity: warning

  build-and-test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Get latest stable stress-ng version
        id: stress_ng
        run: |
          version=$(curl --silent --fail "https://api.github.com/repos/ColinIanKing/stress-ng/tags?per_page=20" \
            | jq -r '[.[] | .name | select(test("^V[0-9]+\\.[0-9]+\\.[0-9]+$"))][0]' \
            | sed 's/^V//')
          if [ -z "$version" ] || [ "$version" = "null" ]; then
            echo "Error: could not fetch stress-ng version" >&2
            exit 1
          fi
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "stress-ng version: ${version}"

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential zlib1g-dev libaio-dev libcap-dev \
            libattr1-dev libsctp-dev libatomic1 libxxhash-dev

      - name: Build static stress-ng
        run: |
          curl -sL "https://github.com/ColinIanKing/stress-ng/archive/V${{ steps.stress_ng.outputs.version }}.tar.gz" | tar xz
          cd "stress-ng-${{ steps.stress_ng.outputs.version }}"
          STATIC=1 make -j"$(nproc)"
          strip stress-ng
          ./stress-ng --version
          cp stress-ng "$GITHUB_WORKSPACE/stress-ng"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: stress-ng:test

      - name: Run integration tests
        run: |
          chmod +x tests/test-docker.sh
          TEST_IMAGE=stress-ng:test ./tests/test-docker.sh
